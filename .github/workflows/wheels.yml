name: Build Wheels

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  LLVM_VERSION: "18.1.8"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: manylinux
            artifact: wheels-linux
            manylinux: manylinux_2_28
          - os: macos-13
            target: macos
            artifact: wheels-macos
            manylinux: ""
          - os: windows-2022
            target: windows
            artifact: wheels-windows
            manylinux: ""
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: wheels-${{ runner.os }}-${{ hashFiles('Cargo.lock') }}
      - name: Restore LLVM toolchain cache
        id: wheel-llvm-cache
        uses: actions/cache@v4
        with:
          path: .deps
          key: llvm-${{ runner.os }}-${{ env.LLVM_VERSION }}
      - name: Fetch LLVM toolchain
        if: steps.wheel-llvm-cache.outputs.cache-hit != 'true'
        run: python tools/prepare_toolchain.py fetch --version ${{ env.LLVM_VERSION }} --install-dir .deps --export-prefix
      - name: Export LLVM prefix (Unix)
        if: runner.os != 'Windows'
        run: echo "LLVM_SYS_181_PREFIX=$(ls -d ${{ github.workspace }}/.deps/clang+llvm-${{ env.LLVM_VERSION }}-*)" >> "$GITHUB_ENV"
      - name: Export LLVM prefix (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $prefix = Get-ChildItem "$env:GITHUB_WORKSPACE/.deps" -Filter "clang+llvm-${{ env.LLVM_VERSION }}*" | Select-Object -First 1
          if (-not $prefix) { throw "LLVM toolchain missing" }
          Add-Content $env:GITHUB_ENV "LLVM_SYS_181_PREFIX=$($prefix.FullName)"
      - name: Install maturin (Windows)
        if: runner.os == 'Windows'
        run: python -m pip install --upgrade pip maturin
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: >-
            --manifest-path bindings/diffsol-pytorch/Cargo.toml
            --release
            --features python
          target: ${{ matrix.target }}
          sdist: ${{ runner.os == 'ubuntu-latest' }}
          manylinux: ${{ matrix.manylinux }}
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: target/wheels/*

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Collect artifacts
        run: |
          mkdir -p upload
          find dist -name "*.whl" -exec cp {} upload/ \;
          find dist -name "*.tar.gz" -exec cp {} upload/ \;
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.10.3
        with:
          packages-dir: upload
          password: ${{ secrets.PYPI_API_TOKEN }}
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: upload/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
