name: Notebooks

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      fail_on_warning:
        description: "Set to false to allow notebook warnings (useful for local debugging)"
        required: false
        default: "true"

jobs:
  run-notebooks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('docs/requirements.txt') }}
      - name: Cache notebook artifacts
        uses: actions/cache@v4
        with:
          path: |
            docs/notebooks/_cache
            docs/notebooks/_data
          key: ${{ runner.os }}-notebooks-${{ hashFiles('docs/notebooks/helpers.py') }}
          restore-keys: |
            ${{ runner.os }}-notebooks-
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r docs/requirements.txt pytest nbmake maturin torch --extra-index-url https://download.pytorch.org/whl/cpu
          maturin develop --manifest-path bindings/diffsol-pytorch/Cargo.toml --features python
      - name: Determine warning flag
        id: warn
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" && "${{ github.event.inputs.fail_on_warning }}" == "false" ]]; then
            echo "flag=" >> "$GITHUB_OUTPUT"
            echo "mode=permissive" >> "$GITHUB_OUTPUT"
          else
            echo "flag=-W error" >> "$GITHUB_OUTPUT"
            echo "mode=strict" >> "$GITHUB_OUTPUT"
          fi
      - name: Execute notebooks
        env:
          NB_EXECUTION_MODE: ${{ steps.warn.outputs.mode }}
        run: |
          WARN_FLAG="${{ steps.warn.outputs.flag }}"
          pytest --nbmake docs/notebooks/*.ipynb --durations=10 ${WARN_FLAG}
